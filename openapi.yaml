openapi: 3.0.3
info:
  title: Cityline Bank API
  version: "1.0.0"
  description: |
    Cityline Bank 데모 웹앱 API 명세(현재 Express 구현 기준).
servers:
  - url: http://localhost:4000
    description: Local development server
security:
  - SessionToken: []

paths:
  /api/health:
    get:
      summary: Health check
      tags:
        - System
      security: []
      responses:
        "200":
          description: 정상
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /api/login:
    post:
      summary: 로그인
      tags:
        - Auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            example:
              accountNo: "1000001"
              pin: "1234"
              role: "customer"
      responses:
        "200":
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "INVALID_CREDENTIALS"

  /api/logout:
    post:
      summary: 로그아웃
      tags:
        - Auth
      responses:
        "200":
          description: 로그아웃 완료
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me:
    get:
      summary: 현재 로그인 계정 조회
      tags:
        - Account
      responses:
        "200":
          description: 로그인 계정 정보
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: 계좌 조회 실패
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "ACCOUNT_NOT_FOUND"

  /api/config:
    get:
      summary: 서버 설정 조회
      tags:
        - Account
      responses:
        "200":
          description: 운영 임계치 조회
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/transactions:
    get:
      summary: 거래 내역 조회
      tags:
        - Transactions
      parameters:
        - name: status
          in: query
          required: false
          description: 상태 필터
          schema:
            $ref: "#/components/schemas/TransactionStatus"
      responses:
        "200":
          description: 거래 목록
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/pending-transfers:
    get:
      summary: 승인 대기 이체 조회
      tags:
        - Transactions
      responses:
        "200":
          description: 승인 대기 이체 목록
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/deposit:
    post:
      summary: 입금
      tags:
        - Transactions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AmountMemoRequest"
            example:
              amount: 10000
              memo: 입금
      responses:
        "201":
          description: 입금 처리 완료
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "400":
          $ref: "#/components/responses/BadAmount"
        "423":
          $ref: "#/components/responses/AccountFrozen"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/withdraw:
    post:
      summary: 출금
      tags:
        - Transactions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AmountMemoRequest"
            example:
              amount: 5000
              memo: 출금
      responses:
        "201":
          description: 출금 처리 완료
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "400":
          $ref: "#/components/responses/BadAmount"
        "409":
          description: 잔액 부족
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "INSUFFICIENT_FUNDS"
        "423":
          $ref: "#/components/responses/AccountFrozen"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/transfer:
    post:
      summary: 이체
      tags:
        - Transactions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransferRequest"
            example:
              toAccountNo: "1000002"
              amount: 20000
              memo: "이체 1000002"
      responses:
        "201":
          description: 즉시 완료 이체
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransferResponse"
              example:
                transaction:
                  id: "txn_1710000000000_1234"
                  ts: "2026-02-22T00:00:00.000Z"
                  type: "이체"
                  actor: "1000001"
                  from: "1000001"
                  to: "1000002"
                  amount: 20000
                  memo: "이체 1000002"
                  status: "COMPLETED"
                  approval: null
                isPendingApproval: false
        "202":
          description: 승인대기 이체
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransferResponse"
              example:
                transaction:
                  id: "txn_1710000000123_5678"
                  ts: "2026-02-22T00:00:00.000Z"
                  type: "이체"
                  actor: "1000001"
                  from: "1000001"
                  to: "1000002"
                  amount: 200000
                  memo: "이체 1000002"
                  status: "PENDING_APPROVAL"
                  approval: null
                isPendingApproval: true
        "400":
          description: 수신 계좌 미입력
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "RECEIVER_REQUIRED"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: 수신 계좌 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "RECEIVER_NOT_FOUND"
        "409":
          description: 계좌 상태/잔액/자기자신 이체 관련 에러
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                insufficientFunds:
                  value:
                    error: "INSUFFICIENT_FUNDS"
                selfTransferNotAllowed:
                  value:
                    error: "SELF_TRANSFER_NOT_ALLOWED"
        "423":
          description: 잠금 계좌
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                sourceFrozen:
                  value:
                    error: "ACCOUNT_FROZEN"
                targetFrozen:
                  value:
                    error: "RECEIVER_FROZEN"

  /api/accounts:
    get:
      summary: 계좌 목록 조회 (관리자)
      tags:
        - Admin
      responses:
        "200":
          description: 고객 계좌 목록
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/admin/accounts:
    post:
      summary: 계좌 생성 (관리자)
      tags:
        - Admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAccountRequest"
            example:
              name: "홍길동"
              pin: "5678"
              initialBalance: 10000
      responses:
        "201":
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateAccountResponse"
        "400":
          description: 입력값 검증 실패
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                nameRequired:
                  value: { error: "NAME_REQUIRED" }
                badPin:
                  value: { error: "BAD_PIN" }
                badInitialBalance:
                  value: { error: "BAD_INITIAL_BALANCE" }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/admin/accounts/{accountNo}/adjust:
    post:
      summary: 계좌 잔액 조정 (관리자)
      tags:
        - Admin
      parameters:
        - $ref: "#/components/parameters/AccountNoPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdjustAccountRequest"
            example:
              amount: -5000
              memo: "수수료 조정"
      responses:
        "201":
          description: 조정 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountAdjustResponse"
        "400":
          description: 입력값 오류
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                badAmount:
                  value: { error: "BAD_AMOUNT" }
        "403":
          description: 권한 관련 에러
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                cannotModifyAdmin:
                  value: { error: "CANNOT_MODIFY_ADMIN_ACCOUNT" }
        "404":
          description: 대상 계좌 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "ACCOUNT_NOT_FOUND"
        "409":
          description: 비즈니스 상태 충돌
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                insufficientFunds:
                  value: { error: "INSUFFICIENT_FUNDS" }
                accountFrozen:
                  value: { error: "ACCOUNT_FROZEN" }
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/admin/accounts/{accountNo}/freeze:
    post:
      summary: 계좌 잠금/해제 토글 (관리자)
      tags:
        - Admin
      parameters:
        - $ref: "#/components/parameters/AccountNoPath"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FreezeRequest"
            example:
              frozen: true
      responses:
        "200":
          description: 잠금 처리 결과
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountFreezeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: 대상 계좌 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "ACCOUNT_NOT_FOUND"

  /api/admin/transactions/{txnId}/approve:
    post:
      summary: 대기 이체 승인 (관리자)
      tags:
        - Admin
      parameters:
        - $ref: "#/components/parameters/TransactionIdPath"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApproveRejectRequest"
            example:
              reason: "관리자 승인"
      responses:
        "200":
          description: 승인 완료
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: 거래 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "TRANSACTION_NOT_FOUND"
        "409":
          description: 상태 전이 실패/거래 대상 계좌 상태 오류
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                notPending:
                  value: { error: "TRANSACTION_NOT_PENDING" }
                invalidAccount:
                  value: { error: "INVALID_ACCOUNT" }
                accountFrozen:
                  value: { error: "ACCOUNT_FROZEN" }
                insufficientFunds:
                  value: { error: "INSUFFICIENT_FUNDS" }
                stateChanged:
                  value: { error: "TRANSACTION_STATE_CHANGED" }

  /api/admin/transactions/{txnId}/reject:
    post:
      summary: 대기 이체 거부 (관리자)
      tags:
        - Admin
      parameters:
        - $ref: "#/components/parameters/TransactionIdPath"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApproveRejectRequest"
            example:
              reason: "관리자 거부"
      responses:
        "200":
          description: 거부 완료
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: 거래 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "TRANSACTION_NOT_FOUND"
        "409":
          description: 승인 대기 상태 아님
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                notPending:
                  value: { error: "TRANSACTION_NOT_PENDING" }
                stateChanged:
                  value: { error: "TRANSACTION_STATE_CHANGED" }

components:
  securitySchemes:
    SessionToken:
      type: apiKey
      in: header
      name: x-auth-token
      description: 로그인 API에서 발급받은 토큰

  parameters:
    AccountNoPath:
      name: accountNo
      in: path
      required: true
      schema:
        type: string
      description: 계좌번호
    TransactionIdPath:
      name: txnId
      in: path
      required: true
      schema:
        type: string
      description: 거래 ID (`txn_*` 형태)

  responses:
    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "AUTH_TOKEN_REQUIRED"
    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "FORBIDDEN"
    BadAmount:
      description: 금액 형식 오류
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "BAD_AMOUNT"
    AccountFrozen:
      description: 계좌 잠금 상태
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "ACCOUNT_FROZEN"
    ServerError:
      description: DB 오류
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "DB_ERROR"
            message: "데이터베이스 처리 중 오류가 발생했습니다."

  schemas:
    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
      required:
        - ok
      example:
        ok: true

    OkResponse:
      type: object
      properties:
        ok:
          type: boolean
      required:
        - ok
      example:
        ok: true

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          example: BAD_REQUEST
        message:
          type: string
          example: error detail

    Account:
      type: object
      required:
        - accountNo
        - role
        - name
        - balance
        - frozen
        - createdAt
      properties:
        accountNo:
          type: string
          example: "1000001"
        role:
          type: string
          enum: [admin, customer]
        name:
          type: string
        balance:
          type: integer
          format: int64
          example: 120000
        frozen:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Approval:
      type: object
      nullable: true
      required:
        - by
        - at
        - reason
      properties:
        by:
          type: string
          nullable: true
        at:
          type: string
          format: date-time
          nullable: true
        reason:
          type: string
          nullable: true

    TransactionType:
      type: string
      enum: ["입금", "출금", "이체", "계좌 생성", "관리자 조정", "계좌 잠금", "계좌 해제"]

    TransactionStatus:
      type: string
      enum: [COMPLETED, PENDING_APPROVAL, REJECTED, FAILED]

    Transaction:
      type: object
      required:
        - id
        - ts
        - type
        - actor
        - from
        - to
        - amount
        - memo
        - status
      properties:
        id:
          type: string
          example: "txn_1710000000000_1234"
        ts:
          type: string
          format: date-time
          example: "2026-02-22T00:00:00.000Z"
        type:
          $ref: "#/components/schemas/TransactionType"
        actor:
          type: string
          example: "1000001"
        from:
          type: string
          example: "1000001"
        to:
          type: string
          example: "1000002"
        amount:
          type: integer
          format: int64
          example: 3000
        memo:
          type: string
          nullable: true
        status:
          $ref: "#/components/schemas/TransactionStatus"
        approval:
          $ref: "#/components/schemas/Approval"
          nullable: true

    TransactionsResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: "#/components/schemas/Transaction"

    TransactionResponse:
      type: object
      properties:
        transaction:
          $ref: "#/components/schemas/Transaction"

    TransferResponse:
      type: object
      properties:
        transaction:
          $ref: "#/components/schemas/Transaction"
        isPendingApproval:
          type: boolean
      required:
        - transaction
        - isPendingApproval

    MeResponse:
      type: object
      properties:
        account:
          $ref: "#/components/schemas/Account"
        approvalThreshold:
          type: integer
          format: int64
          example: 100000

    ConfigResponse:
      type: object
      properties:
        approvalThreshold:
          type: integer
          format: int64
          example: 100000

    AccountsResponse:
      type: object
      properties:
        accounts:
          type: array
          items:
            $ref: "#/components/schemas/Account"

    LoginRequest:
      type: object
      required:
        - accountNo
        - pin
        - role
      properties:
        accountNo:
          type: string
        pin:
          type: string
        role:
          type: string
          enum: [admin, customer]

    LoginResponse:
      type: object
      properties:
        token:
          type: string
        account:
          $ref: "#/components/schemas/Account"
        approvalThreshold:
          type: integer
          format: int64
          example: 100000

    AmountMemoRequest:
      type: object
      required:
        - amount
      properties:
        amount:
          type: integer
          minimum: 1
          example: 10000
        memo:
          type: string
          maxLength: 200

    TransferRequest:
      type: object
      required:
        - toAccountNo
        - amount
      properties:
        toAccountNo:
          type: string
        amount:
          type: integer
          minimum: 1
          example: 20000
        memo:
          type: string
          maxLength: 200
      description: memo 미입력 시 서버에서 `이체 {toAccountNo}`로 기본 생성

    CreateAccountRequest:
      type: object
      required:
        - name
        - pin
      properties:
        name:
          type: string
        pin:
          type: string
          minLength: 4
          maxLength: 8
          pattern: "^[0-9]{4,8}$"
        initialBalance:
          type: integer
          minimum: 0
          default: 0

    CreateAccountResponse:
      type: object
      properties:
        accountNo:
          type: string
        account:
          $ref: "#/components/schemas/Account"
        transaction:
          $ref: "#/components/schemas/Transaction"

    AdjustAccountRequest:
      type: object
      required:
        - amount
      properties:
        amount:
          type: integer
          description: 정수(0 제외)
        memo:
          type: string
          maxLength: 200

    AccountAdjustResponse:
      type: object
      properties:
        account:
          $ref: "#/components/schemas/Account"
        transaction:
          $ref: "#/components/schemas/Transaction"

    FreezeRequest:
      type: object
      properties:
        frozen:
          type: boolean

    AccountFreezeResponse:
      type: object
      properties:
        account:
          $ref: "#/components/schemas/Account"
        transaction:
          $ref: "#/components/schemas/Transaction"
        updated:
          type: boolean

    ApproveRejectRequest:
      type: object
      properties:
        reason:
          type: string
          maxLength: 255
